Here is the properly formatted Product Requirements Document. I have cleaned up the indentation, corrected the section numbering (fixing the duplicate "Section 3"), and formalized the "Implementation Hint" into an Appendix to keep the document professional.

---

# Product Requirements Document (PRD)

| **Project Name** | BlueHorseshoe Trading Engine |
| --- | --- |
| **Version** | 1.1 (SaaS/Automation Update) |
| **Status** | Active / In-Development |

## 1. Executive Summary

BlueHorseshoe is an automated swing trading analysis engine designed to identify high-probability stock market entry and exit points. Unlike standard technical screeners, BlueHorseshoe employs a "closed-loop" system that grades its own past predictions and uses Machine Learning (Random Forest) to filter future signals, adapting to changing market conditions.

## 2. Target Audience

* **Primary User:** Quantitative Retail Traders (Swing Traders).
* **Goals:** Minimize emotional trading errors, automate the search for setups, and execute trades with predefined risk parameters (Stop Loss/Take Profit).

## 3. Functional Requirements

### 3.1 Data Ingestion & Management

* **Market Data:** The system must fetch daily OHLCV (Open, High, Low, Close, Volume) data from external APIs (currently AlphaVantage).
* **Bellwether Check:** Before running batch updates, the system must verify market data freshness using a "bellwether" symbol (e.g., SPY) to prevent processing stale data on holidays.
* **Persistence:** All historical data and generated scores must be persisted in a database (MongoDB) to allow for historical backtesting and grading.

### 3.2 Trading Strategies

The engine must support multiple distinct trading strategies, selectable via configuration:

* **Strategy A: Baseline (Trend Following)**
* *Trigger:* Identifies pullbacks in an established uptrend.
* *Entry:* Based on EMA crossovers and volume confirmation.
* *Exit:* Defined Take Profit targets relative to volatility (ATR).


* **Strategy B: Mean Reversion (Dip Buying)**
* *Trigger:* Identifies statistically significant deviations from the mean (20-day EMA).
* *Entry:* Buys on weakness (price drop).
* *Exit:* Reversion to the mean.



### 3.3 The Grading Engine (Feedback Loop)

* **Automated Evaluation:** The system must continually "look back" at past predictions (Scores) and compare them to actual subsequent market performance.
* **Scoring Criteria:** A trade is marked "Success" if it hits the Target before the Stop Loss; otherwise "Failure."
* **Metric Tracking:** The engine must calculate Win Rate, Average PnL, and Maximum Adverse Excursion (MAE) for every strategy.

### 3.4 Machine Learning Overlay

* **Signal Filtering:** The system must use a trained Random Forest Classifier to assess the probability of a signal's success.
* **Dynamic Training:** The model must be retrainable on the dataset generated by the Grading Engine, effectively "learning" from the system's own past mistakes.

### 3.5 Reporting

* **Daily Output:** The system must generate a "Top Candidates" list for the target date, filtered by the ML probability score.
* **Actionable Metrics:** Reports must include specific Entry Price, Stop Loss, and Take Profit levels for each candidate.

### 3.6 Automation & Scheduling

* **Requirement:** The system must implement a **Job Scheduler** (e.g., Cron, Celery, or APScheduler) to execute tasks without user intervention.
* **Daily Workflow:**
* **06:00 AM:** Trigger `Backfill` routine to fetch previous day's closing data.
* **06:15 AM:** Execute `Prediction Engine` for the active strategy universe.
* **06:30 AM:** Generate Reports.
* **06:35 AM:** Dispatch Notifications (Email).


* **Retry Logic:** If the Bellwether check fails (market data not ready), the scheduler must retry every 30 minutes up to a hard deadline (e.g., 9:00 AM).

### 3.7 Notification System

* **Requirement:** The system must support outbound communication via SMTP (Email) or Webhook (Slack/Discord).
* **Content:** Emails must contain the "Top 10" table and embedded images of the generated technical charts.
* **Alerts:** Immediate notification upon system failure (e.g., DB connection loss, API quota exceeded).

### 3.8 Web Interface

* **Requirement:** A read-only Web Dashboard to display the latest generated report.
* **Data Source:** The dashboard will consume the JSON output from `run_daily()`.
* **Access Control:** Basic authentication (API Key or Login) to prevent public access to proprietary signals.

## 4. Technical Requirements

* **Language:** Python 3.10+
* **Database:** MongoDB (NoSQL) for flexible schema storage of financial time-series and trade logs.
* **Infrastructure:** The application must be containerized (Docker) to ensure consistency across development and production environments.
* **Libraries:**
* `pandas` / `numpy` for vectorized calculation.
* `scikit-learn` for the Random Forest implementation.
* `ta` (Technical Analysis library) for indicator calculation.


* **Application Server:** The Python environment must host a web server (FastAPI/Uvicorn) to serve the dashboard and handle trigger endpoints.
* **State Management:** The `ReportSingleton` class must be adapted to return data objects (JSON) to the API rather than just writing to `report.txt`.
* **Asset Hosting:** The `graph()` function currently saves PNGs to a local `/src/graphs/` folder. For a web/email app, these images must be either:
1. Converted to Base64 strings for direct embedding in HTML emails.
2. Uploaded to cloud storage (S3/GCS) with a public URL.
3. Served via a static file endpoint in FastAPI.



## 5. Success Metrics (KPIs)

* **Win Rate:** Target > 60% for "Baseline" strategy trades filtered by ML > 70% probability.
* **Profit Factor:** Ratio of Gross Profit / Gross Loss must exceed 1.5.
* **Uptime:** The system must successfully complete its data fetch and prediction cycle before market open (9:30 AM ET).

## 6. User Experience (Flow)

### 6.1 Previous Flow (Manual)

1. User logs into terminal.
2. User runs `python src/main.py -u` (waits 5 mins).
3. User runs `python src/main.py -p`.
4. User opens `report.txt` to read picks.

### 6.2 Target Flow (Automated)

1. **Passive:** User wakes up and checks Email on their phone.
2. **Review:** Email contains "Top 3 Baseline Picks" with charts attached.
3. **Deep Dive:** User clicks "View Full Report" link in email, which opens the BlueHorseshoe Web Dashboard showing the full Top 10 and detailed metrics.
4. **No Action Required:** If the market is closed or data failed, the email explicitly states "No Trading Today: Market Holiday."

---

## Appendix A: Implementation Notes

* **API Readiness:** The existing `run_daily` function in `service.py` already generates the required Dictionary (`report.to_dict()`) structure, making the transition to a Web API straightforward.
* **Task Runner Strategy:**
* *Simplest:* A `cron` job on a server that runs `python main.py -p` and pipes the output to a new `send_email.py` script.
* *Robust:* A FastAPI endpoint `/api/trigger-daily-scan` that is called via a cloud scheduler (like GitHub Actions or AWS EventBridge).
